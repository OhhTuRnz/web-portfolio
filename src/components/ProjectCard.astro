---
export interface Props {
  project: {
    id: string;
    title: string;
    description: string;
    shortDescription: string;
    technologies: string[];
    category: string;
    status: string;
    media?: {
      type: string;
      url: string;
      poster?: string;
      thumbnail?: string;
    };
    links: {
      github?: string;
      demo?: string;
      paper?: string;
    };
    featured?: boolean;
  };
  index?: number;
}

const { project, index = 0 } = Astro.props;

const techColors = {
  'Python': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300',
  'PyTorch': 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300',
  'ROS2': 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300',
  'ROS': 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300',
  'C++': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
  'JavaScript': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
  'React': 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300',
  'MATLAB': 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300',
  'OpenGL': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
  'TensorFlow': 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300',
  'Reinforcement Learning': 'bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300',
  'Advanced RL': 'bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300',
  'Space Systems': 'bg-violet-100 text-violet-800 dark:bg-violet-900/30 dark:text-violet-300',
  'Kerbal': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
  'Mission Planning': 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300',
  'Neural Networks': 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300',
  'Autonomous Systems': 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300',
  'Game AI': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
  'default': 'bg-gray-100 text-gray-800 dark:bg-gray-700/30 dark:text-gray-300'
};

const categoryColors = {
  'research': 'bg-blue-600',
  'personal': 'bg-purple-600'
};

const statusColors = {
  'active': 'text-green-400 bg-green-900/20 border-green-500/30',
  'completed': 'text-gray-400 bg-gray-900/20 border-gray-500/30'
};

// Helper function to check if URL is YouTube
const isYouTubeUrl = (url) => {
  return url && (url.includes('youtube.com') || url.includes('youtu.be'));
};

// Helper function to get YouTube video ID
const getYouTubeVideoId = (url) => {
  if (!url) return null;
  
  let videoId = null;
  
  if (url.includes('youtube.com/watch?v=')) {
    videoId = url.split('v=')[1]?.split('&')[0];
  } else if (url.includes('youtu.be/')) {
    videoId = url.split('youtu.be/')[1]?.split('?')[0];
  } else if (url.includes('youtube.com/embed/')) {
    videoId = url.split('embed/')[1]?.split('?')[0];
  }
  
  return videoId;
};

// Helper function to get YouTube thumbnail
const getYouTubeThumbnail = (url, quality = 'maxresdefault') => {
  const videoId = getYouTubeVideoId(url);
  if (!videoId) return null;
  
  return `https://img.youtube.com/vi/${videoId}/${quality}.jpg`;
};
---

<article 
  class="project-card group relative bg-slate-800/40 backdrop-blur-sm rounded-xl overflow-hidden border border-slate-700/30 hover:border-blue-500/50 transition-all duration-500 hover:transform hover:scale-105 hover:shadow-2xl"
  style={`animation-delay: ${index * 0.1}s;`}
  role="article"
  aria-labelledby={`project-title-${project.id}`}
  tabindex="0"
  data-project={JSON.stringify(project)}
>
  <!-- Media Section -->
  <div class="relative overflow-hidden aspect-video bg-slate-900/50">
    {project.media ? (
      project.media.type === 'video' ? (
        isYouTubeUrl(project.media.url) ? (
          <!-- WORKING YouTube Video with REAL Hover Preview -->
          <div class="youtube-video-container relative w-full h-full" 
               data-video-url={project.media.url} 
               data-video-id={getYouTubeVideoId(project.media.url)}>
            
            <!-- Main Thumbnail -->
            <div class="youtube-thumbnail-preview relative w-full h-full cursor-pointer group">
              <!-- High Quality Thumbnail -->
              <img 
                src={getYouTubeThumbnail(project.media.url, 'maxresdefault')}
                alt={`${project.title} - YouTube Video Thumbnail`}
                class="w-full h-full object-cover transition-all duration-700 group-hover:scale-110 group-hover:brightness-75"
                loading="lazy"
                onerror={`
                  this.onerror=null;
                  this.src='${getYouTubeThumbnail(project.media.url, 'hqdefault')}';
                  this.onerror=function(){
                    this.onerror=null;
                    this.src='https://images.pexels.com/photos/8386440/pexels-photo-8386440.jpeg?auto=compress&cs=tinysrgb&w=800';
                  };
                `}
              />
              
              <!-- HOVER PREVIEW - Shows actual video preview on hover -->
              <div class="hover-preview-container absolute inset-0 opacity-0 group-hover:opacity-100 transition-all duration-500 z-10 hidden md:block bg-black">
                <!-- Loading State -->
                <div class="preview-loading absolute inset-0 flex items-center justify-center bg-slate-900">
                  <div class="flex flex-col items-center gap-3">
                    <div class="w-8 h-8 border-2 border-red-600 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-white text-sm">Loading preview...</p>
                  </div>
                </div>
                
                <!-- Video Preview -->
                <div class="preview-video absolute inset-0 hidden">
                  <!-- Iframe will be inserted here -->
                </div>
                
                <!-- Fallback Message -->
                <div class="preview-fallback absolute inset-0 bg-slate-900 flex items-center justify-center text-center p-4 hidden">
                  <div>
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    <p class="text-white text-sm mb-2">Preview Unavailable</p>
                    <p class="text-gray-400 text-xs mb-3">This video cannot be embedded</p>
                    <a href={project.media.url} target="_blank" class="inline-flex items-center gap-2 bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                      </svg>
                      Watch on YouTube
                    </a>
                  </div>
                </div>
              </div>
              
              <!-- Play Button Overlay -->
              <div class="absolute inset-0 bg-black/30 flex items-center justify-center group-hover:bg-black/10 transition-all duration-300">
                <div class="play-button relative">
                  <!-- Pulsing ring animation -->
                  <div class="absolute inset-0 w-20 h-20 bg-red-600/30 rounded-full animate-ping"></div>
                  <div class="absolute inset-0 w-20 h-20 bg-red-600/20 rounded-full animate-pulse"></div>
                  
                  <!-- Main play button -->
                  <div class="relative w-20 h-20 bg-red-600 rounded-full flex items-center justify-center shadow-2xl transform group-hover:scale-110 transition-all duration-300 hover:bg-red-700 cursor-pointer z-10">
                    <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </div>
                </div>
              </div>
              
              <!-- YouTube Branding -->
              <div class="absolute top-4 right-4 bg-red-600 text-white px-3 py-1 rounded text-sm font-semibold flex items-center gap-1 shadow-lg">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                YouTube
              </div>
              
              <!-- Hover Indicator -->
              <div class="absolute bottom-4 left-4 bg-black/80 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                <span class="hidden sm:inline">Hover Preview</span>
                <span class="sm:hidden">Preview</span>
              </div>
            </div>
            
            <!-- Full-Screen Modal for Video -->
            <div class="youtube-modal-overlay fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
              <div class="relative w-full max-w-6xl aspect-video bg-black rounded-lg overflow-hidden">
                <!-- Close Button -->
                <button class="close-video absolute top-4 right-4 bg-black/70 text-white p-3 rounded-full hover:bg-black/90 transition-colors z-20 md:top-6 md:right-6">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
                
                <!-- Open in YouTube Button -->
                <a class="open-youtube absolute top-4 left-4 bg-red-600 text-white px-4 py-2 rounded-full text-sm hover:bg-red-700 transition-colors z-20 flex items-center gap-2 md:top-6 md:left-6" 
                   target="_blank" 
                   rel="noopener noreferrer">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                  </svg>
                  <span class="hidden sm:inline">Open in YouTube</span>
                  <span class="sm:hidden">YouTube</span>
                </a>
                
                <!-- Loading Indicator -->
                <div class="loading-indicator absolute inset-0 flex items-center justify-center bg-slate-900">
                  <div class="flex flex-col items-center gap-4">
                    <div class="w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-white text-sm">Loading video...</p>
                  </div>
                </div>
                
                <!-- Video Container -->
                <div class="video-container w-full h-full">
                  <!-- Iframe will be inserted here -->
                </div>
                
                <!-- Fallback Message -->
                <div class="fallback-message hidden absolute inset-0 flex items-center justify-center bg-slate-900 text-center p-8">
                  <div class="max-w-md">
                    <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                    <h3 class="text-white text-lg font-semibold mb-2">Video Preview Unavailable</h3>
                    <p class="text-gray-300 text-sm mb-4">This video cannot be embedded due to YouTube's restrictions.</p>
                    <a class="inline-flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors" 
                       target="_blank" 
                       rel="noopener noreferrer">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                      </svg>
                      Watch on YouTube
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <!-- Regular Video -->
          <div class="relative w-full h-full">
            <video 
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              poster={project.media.poster || project.media.thumbnail}
              muted
              loop
              playsinline
              preload="metadata"
              aria-label={`Video demonstration of ${project.title}`}
            >
              <source src={project.media.url} type="video/mp4" />
              <p>Your browser does not support the video tag.</p>
            </video>
            
            <!-- Video overlay -->
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            
            <!-- Play indicator -->
            <div class="absolute inset-0 flex items-center justify-center opacity-70 group-hover:opacity-0 transition-opacity duration-300">
              <div class="w-16 h-16 bg-black/50 rounded-full flex items-center justify-center backdrop-blur-sm">
                <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                </svg>
              </div>
            </div>
          </div>
        )
      ) : (
        <div class="relative w-full h-full">
          <img 
            src={project.media.url} 
            alt={`${project.title} preview`}
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
            loading="lazy"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </div>
      )
    ) : (
      <!-- Fallback gradient -->
      <div class="w-full h-full bg-gradient-to-br from-blue-600/20 via-purple-600/20 to-cyan-600/20 flex items-center justify-center">
        <div class="text-white/30 text-6xl">
          {project.category === 'research' ? '🔬' : '🚀'}
        </div>
      </div>
    )}
    
    <!-- Category and Status badges -->
    <div class="absolute top-4 left-4 flex items-center space-x-2">
      <span class={`px-3 py-1 rounded-full text-xs font-semibold text-white ${categoryColors[project.category]}`}>
        {project.category === 'research' ? '🔬 Research' : '🚀 Personal'}
      </span>
      {project.featured && (
        <span class="px-2 py-1 text-xs font-medium text-yellow-300 bg-yellow-600/20 rounded-full border border-yellow-500/30">
          ⭐ Featured
        </span>
      )}
    </div>
    
    <div class="absolute top-4 right-4">
      <span class={`px-2 py-1 text-xs font-medium rounded-full border ${statusColors[project.status]}`}>
        {project.status}
      </span>
    </div>
  </div>

  <!-- Content -->
  <div class="p-6 flex flex-col flex-grow">
    <h3 id={`project-title-${project.id}`} class="text-xl font-semibold text-white mb-3 group-hover:text-blue-400 transition-colors leading-tight">
      {project.title}
    </h3>
    
    <p class="text-gray-300 mb-4 leading-relaxed flex-grow text-sm">
      {project.shortDescription}
    </p>
    
    <!-- Technologies -->
    <div class="flex flex-wrap gap-2 mb-6" role="list" aria-label="Technologies used">
      {project.technologies.slice(0, 4).map(tech => (
        <span 
          class={`px-3 py-1 text-xs font-medium rounded-full transition-all hover:scale-105 ${techColors[tech] || techColors.default}`}
          role="listitem"
        >
          {tech}
        </span>
      ))}
      {project.technologies.length > 4 && (
        <span class="px-3 py-1 text-xs font-medium rounded-full bg-gray-700/50 text-gray-300">
          +{project.technologies.length - 4} more
        </span>
      )}
    </div>
    
    <!-- Action buttons -->
    <div class="flex flex-wrap gap-3 mt-auto" role="group" aria-label="Project links">
      {project.links.github && (
        <a 
          href={project.links.github} 
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center space-x-2 text-gray-300 hover:text-white transition-colors hover:bg-slate-700/50 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
          aria-label={`View ${project.title} source code on GitHub`}
        >
          <i class="fab fa-github" aria-hidden="true"></i>
          <span class="text-sm">Code</span>
        </a>
      )}
      
      {project.links.demo && (
        <a 
          href={project.links.demo}
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center space-x-2 text-blue-400 hover:text-blue-300 transition-colors hover:bg-blue-900/20 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
          aria-label={`View ${project.title} demo`}
        >
          {isYouTubeUrl(project.links.demo) ? (
            <i class="fab fa-youtube" aria-hidden="true"></i>
          ) : (
            <i class="fas fa-external-link-alt" aria-hidden="true"></i>
          )}
          <span class="text-sm">{isYouTubeUrl(project.links.demo) ? 'Video' : 'Demo'}</span>
        </a>
      )}
      
      {project.links.paper && (
        <a 
          href={project.links.paper}
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center space-x-2 text-purple-400 hover:text-purple-300 transition-colors hover:bg-purple-900/20 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/50"
          aria-label={`Read ${project.title} research paper`}
        >
          <i class="fas fa-file-pdf" aria-hidden="true"></i>
          <span class="text-sm">Paper</span>
        </a>
      )}
    </div>
  </div>
</article>

<style>
  .project-card {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
    transform: translateY(30px);
  }
  
  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .aspect-video {
    aspect-ratio: 16 / 9;
  }
  
  /* Enhanced hover effects */
  .project-card:hover {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  }
  
  /* Focus styles for accessibility */
  .project-card:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }
  
  /* WORKING HOVER PREVIEW SYSTEM */
  .hover-preview-container {
    transition: opacity 0.5s ease;
  }
  
  /* Enhanced YouTube play button with animations */
  .play-button {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .play-button:hover .relative {
    background-color: #dc2626;
    transform: scale(1.15);
    box-shadow: 0 0 30px rgba(220, 38, 38, 0.6);
  }
  
  /* Modal styling */
  .youtube-modal-overlay {
    backdrop-filter: blur(10px);
    z-index: 9999;
  }
  
  .youtube-modal-overlay.visible {
    display: flex !important;
  }
  
  /* Loading and error states */
  .loading-indicator {
    transition: opacity 0.3s ease;
  }
  
  .loading-indicator.hidden {
    opacity: 0;
    pointer-events: none;
  }
  
  .fallback-message.visible {
    display: flex !important;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .youtube-modal-overlay .relative {
      margin: 1rem;
      max-height: calc(100vh - 2rem);
    }
    
    .close-video, .open-youtube {
      top: 1rem;
    }
    
    .close-video {
      right: 1rem;
    }
    
    .open-youtube {
      left: 1rem;
    }
    
    /* Hide hover preview on mobile */
    .hover-preview-container {
      display: none !important;
    }
  }
  
  /* Video interaction */
  .project-card:hover video {
    animation: playHint 0.3s ease-in-out;
  }
  
  @keyframes playHint {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const projectCards = document.querySelectorAll('.project-card');
    
    projectCards.forEach(card => {
      const video = card.querySelector('video');
      const youtubeContainer = card.querySelector('.youtube-video-container');
      
      // Handle regular video playback
      if (video) {
        card.addEventListener('mouseenter', () => {
          video.play().catch(() => {
            // Silently handle autoplay restrictions
          });
        });
        
        card.addEventListener('mouseleave', () => {
          video.pause();
          video.currentTime = 0;
        });
        
        // Handle focus for accessibility
        card.addEventListener('focus', () => {
          video.play().catch(() => {});
        });
        
        card.addEventListener('blur', () => {
          video.pause();
          video.currentTime = 0;
        });
      }
      
      // Handle YouTube video functionality
      if (youtubeContainer) {
        const videoUrl = youtubeContainer.dataset.videoUrl;
        const videoId = youtubeContainer.dataset.videoId;
        const thumbnailPreview = youtubeContainer.querySelector('.youtube-thumbnail-preview');
        const hoverPreviewContainer = youtubeContainer.querySelector('.hover-preview-container');
        const previewLoading = hoverPreviewContainer?.querySelector('.preview-loading');
        const previewVideo = hoverPreviewContainer?.querySelector('.preview-video');
        const previewFallback = hoverPreviewContainer?.querySelector('.preview-fallback');
        const modalOverlay = youtubeContainer.querySelector('.youtube-modal-overlay');
        const closeButton = modalOverlay?.querySelector('.close-video');
        const openYouTubeButton = modalOverlay?.querySelector('.open-youtube');
        const playButton = youtubeContainer.querySelector('.play-button');
        
        if (videoId && videoUrl) {
          // Set up YouTube links
          if (openYouTubeButton) openYouTubeButton.href = videoUrl;
          
          let hoverTimeout;
          let isHoverPreviewLoaded = false;
          let hoverIframe = null;
          
          // WORKING HOVER PREVIEW SYSTEM
          if (hoverPreviewContainer && window.innerWidth >= 768) {
            
            // Mouse enter - load hover preview with delay
            youtubeContainer.addEventListener('mouseenter', () => {
              hoverTimeout = setTimeout(() => {
                if (!isHoverPreviewLoaded) {
                  console.log('🎬 Loading hover preview for video:', videoId);
                  loadHoverPreview();
                }
              }, 800); // 800ms delay for better UX
            });
            
            // Mouse leave - clear timeout and cleanup
            youtubeContainer.addEventListener('mouseleave', () => {
              clearTimeout(hoverTimeout);
              
              // Clean up after a delay to allow for smooth transitions
              setTimeout(() => {
                if (hoverIframe) {
                  hoverIframe.src = 'about:blank';
                  hoverIframe.remove();
                  hoverIframe = null;
                }
                isHoverPreviewLoaded = false;
                
                // Reset states
                if (previewLoading) previewLoading.classList.remove('hidden');
                if (previewVideo) previewVideo.classList.add('hidden');
                if (previewFallback) previewFallback.classList.add('hidden');
              }, 1000);
            });
            
            // Function to load hover preview
            const loadHoverPreview = () => {
              if (!previewVideo || !videoId) return;
              
              // Show loading state
              if (previewLoading) previewLoading.classList.remove('hidden');
              if (previewVideo) previewVideo.classList.add('hidden');
              if (previewFallback) previewFallback.classList.add('hidden');
              
              // Create iframe for hover preview
              hoverIframe = document.createElement('iframe');
              hoverIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&playsinline=1&start=5&end=30`;
              hoverIframe.className = 'w-full h-full';
              hoverIframe.setAttribute('frameborder', '0');
              hoverIframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
              hoverIframe.setAttribute('title', `${card.querySelector('h3')?.textContent || 'Video'} - Hover Preview`);
              
              let loaded = false;
              let errorTimeout;
              
              // Success handler
              hoverIframe.onload = () => {
                if (!loaded) {
                  loaded = true;
                  clearTimeout(errorTimeout);
                  
                  console.log('✅ Hover preview loaded successfully');
                  
                  // Hide loading, show video
                  if (previewLoading) previewLoading.classList.add('hidden');
                  if (previewVideo) {
                    previewVideo.innerHTML = '';
                    previewVideo.appendChild(hoverIframe);
                    previewVideo.classList.remove('hidden');
                  }
                  
                  isHoverPreviewLoaded = true;
                }
              };
              
              // Error handler
              hoverIframe.onerror = () => {
                if (!loaded) {
                  loaded = true;
                  clearTimeout(errorTimeout);
                  console.log('❌ Hover preview failed to load');
                  showHoverFallback();
                }
              };
              
              // Timeout handler for embedding restrictions
              errorTimeout = setTimeout(() => {
                if (!loaded) {
                  loaded = true;
                  console.log('⏰ Hover preview timed out');
                  showHoverFallback();
                }
              }, 5000);
              
              // Function to show fallback
              const showHoverFallback = () => {
                if (previewLoading) previewLoading.classList.add('hidden');
                if (previewVideo) previewVideo.classList.add('hidden');
                if (previewFallback) previewFallback.classList.remove('hidden');
                
                isHoverPreviewLoaded = true; // Prevent retries
              };
            };
          }
          
          // Function to show full-screen video modal
          const showVideoModal = () => {
            modalOverlay.classList.remove('hidden');
            modalOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
            
            // Load video
            loadYouTubeVideo();
          };
          
          // Function to hide video modal
          const hideVideoModal = () => {
            modalOverlay.classList.add('hidden');
            modalOverlay.classList.remove('visible');
            document.body.style.overflow = '';
            
            // Clear video content
            const videoContainer = modalOverlay.querySelector('.video-container');
            if (videoContainer) {
              videoContainer.innerHTML = '';
            }
            
            // Reset states
            const loadingIndicator = modalOverlay.querySelector('.loading-indicator');
            const fallbackMessage = modalOverlay.querySelector('.fallback-message');
            if (loadingIndicator) {
              loadingIndicator.classList.remove('hidden');
            }
            if (fallbackMessage) {
              fallbackMessage.classList.remove('visible');
              fallbackMessage.classList.add('hidden');
            }
          };
          
          // Function to load YouTube video in modal
          const loadYouTubeVideo = () => {
            const videoContainer = modalOverlay.querySelector('.video-container');
            const loadingIndicator = modalOverlay.querySelector('.loading-indicator');
            const fallbackMessage = modalOverlay.querySelector('.fallback-message');
            
            if (!videoContainer || !videoId) return;
            
            console.log('🎬 Loading full-screen video for:', videoId);
            
            // Show loading indicator
            if (loadingIndicator) {
              loadingIndicator.classList.remove('hidden');
            }
            
            // Create iframe
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
            iframe.className = 'w-full h-full';
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allowfullscreen', '');
            iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
            iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
            iframe.setAttribute('title', `${card.querySelector('h3')?.textContent || 'Video'} - YouTube Video`);
            
            let loaded = false;
            let errorTimeout;
            
            iframe.onload = () => {
              if (!loaded) {
                loaded = true;
                clearTimeout(errorTimeout);
                
                console.log('✅ Full-screen video loaded successfully');
                
                if (loadingIndicator) {
                  loadingIndicator.classList.add('hidden');
                }
                
                videoContainer.innerHTML = '';
                videoContainer.appendChild(iframe);
              }
            };
            
            iframe.onerror = () => {
              if (!loaded) {
                loaded = true;
                clearTimeout(errorTimeout);
                console.log('❌ Full-screen video failed to load');
                showFallbackMessage();
              }
            };
            
            // Timeout for embedding issues
            errorTimeout = setTimeout(() => {
              if (!loaded) {
                loaded = true;
                console.log('⏰ Full-screen video timed out');
                showFallbackMessage();
              }
            }, 8000);
            
            const showFallbackMessage = () => {
              if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
              }
              if (fallbackMessage) {
                fallbackMessage.classList.remove('hidden');
                fallbackMessage.classList.add('visible');
                
                const fallbackLink = fallbackMessage.querySelector('a');
                if (fallbackLink) {
                  fallbackLink.href = videoUrl;
                }
              }
            };
          };
          
          // Event listeners for modal
          if (playButton) {
            playButton.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              showVideoModal();
            });
            
            playButton.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                e.stopPropagation();
                showVideoModal();
              }
            });
            
            playButton.setAttribute('tabindex', '0');
            playButton.setAttribute('role', 'button');
            playButton.setAttribute('aria-label', `Preview ${card.querySelector('h3')?.textContent || 'video'}`);
          }
          
          if (closeButton) {
            closeButton.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              hideVideoModal();
            });
          }
          
          modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
              hideVideoModal();
            }
          });
          
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalOverlay.classList.contains('visible')) {
              hideVideoModal();
            }
          });
          
          // Handle mobile touch events
          let touchStartY = 0;
          modalOverlay.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
          });
          
          modalOverlay.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const deltaY = touchStartY - touchEndY;
            
            if (deltaY < -50 && e.target === modalOverlay) {
              hideVideoModal();
            }
          });
        }
      }
    });
  });
</script>